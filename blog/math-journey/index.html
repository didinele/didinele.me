<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>A journey through code optimization (and highschool math) | DD's blog</title><meta name=keywords content="math,algorithms,programming,optimization"><meta name=description content="Introduction At the time of writing this, I&rsquo;m a highschool student. With the way our school system is laid out, I end up doing a lot of math - more so than computer science - and lately I&rsquo;ve been very passionate about it.
Anyways, our story begins on the 5th of February, 2023. I was working on a Discord bot for ChatSift, responsible for some sort of leveling system - users would gain XP for sending messages, and crossing certain thresholds would cause you to level up."><meta name=author content="didinele"><link rel=canonical href=https://didinele.me/blog/math-journey/><link crossorigin=anonymous href=/assets/css/stylesheet.deec51b4ebb14229cda677d98d194ddeeebc27943c57f551ca001ed945bcb9ec.css integrity="sha256-3uxRtOuxQinNpnfZjRlN3u68J5Q8V/VRygAe2UW8uew=" rel="preload stylesheet" as=style><link rel=icon href=https://didinele.me/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://didinele.me/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://didinele.me/favicon-32x32.png><link rel=apple-touch-icon href=https://didinele.me/apple-touch-icon.png><link rel=mask-icon href=https://didinele.me/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="A journey through code optimization (and highschool math)"><meta property="og:description" content="Introduction At the time of writing this, I&rsquo;m a highschool student. With the way our school system is laid out, I end up doing a lot of math - more so than computer science - and lately I&rsquo;ve been very passionate about it.
Anyways, our story begins on the 5th of February, 2023. I was working on a Discord bot for ChatSift, responsible for some sort of leveling system - users would gain XP for sending messages, and crossing certain thresholds would cause you to level up."><meta property="og:type" content="article"><meta property="og:url" content="https://didinele.me/blog/math-journey/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2023-02-06T19:28:24+02:00"><meta property="article:modified_time" content="2023-02-06T19:28:24+02:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="A journey through code optimization (and highschool math)"><meta name=twitter:description content="Introduction At the time of writing this, I&rsquo;m a highschool student. With the way our school system is laid out, I end up doing a lot of math - more so than computer science - and lately I&rsquo;ve been very passionate about it.
Anyways, our story begins on the 5th of February, 2023. I was working on a Discord bot for ChatSift, responsible for some sort of leveling system - users would gain XP for sending messages, and crossing certain thresholds would cause you to level up."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Blogs","item":"https://didinele.me/blog/"},{"@type":"ListItem","position":3,"name":"A journey through code optimization (and highschool math)","item":"https://didinele.me/blog/math-journey/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"A journey through code optimization (and highschool math)","name":"A journey through code optimization (and highschool math)","description":"Introduction At the time of writing this, I\u0026rsquo;m a highschool student. With the way our school system is laid out, I end up doing a lot of math - more so than computer science - and lately I\u0026rsquo;ve been very passionate about it.\nAnyways, our story begins on the 5th of February, 2023. I was working on a Discord bot for ChatSift, responsible for some sort of leveling system - users would gain XP for sending messages, and crossing certain thresholds would cause you to level up.","keywords":["math","algorithms","programming","optimization"],"articleBody":"Introduction At the time of writing this, I’m a highschool student. With the way our school system is laid out, I end up doing a lot of math - more so than computer science - and lately I’ve been very passionate about it.\nAnyways, our story begins on the 5th of February, 2023. I was working on a Discord bot for ChatSift, responsible for some sort of leveling system - users would gain XP for sending messages, and crossing certain thresholds would cause you to level up. As I was working out my database schema, I landed on this:\nmodel User { userId String guildId String xp Int @default(0) @@id([userId, guildId]) } and thought to myself, “hmm, I could potentially get away with not storing the current level, and just calculate it on the fly.”\nThe main reason I even thought of this was because the formula to determine the XP required for a given level is $base + (level - 1) * multiplier$. For example, if the base was 100, and the multiplier was 50, then the XP required for level 1 would be 100, and the XP required for level 2 would be 150, and so on. This is a very simple formula, and it would be trivial to track if the user had enough XP to level up, and if so, increment their level and subtract the XP on the fly, but I thought it would be a headache to have to recompute the level for every user in the whole community if an admin decided to change the base or the multiplier.\nOptimization problems As such, I opted to not store the level, and instead just store the total XP the user has ever accumulated, and compute the level on the fly as-needed. At this point, I realized that calculating how much XP is needed for say, level 3, is the sum of the XP required for levels 1, 2, and the usual $base + (level - 1) * multiplier$.\nI then decided to represent this mathematically before implementing it, and I ended up with this:\n$$ n, m \\in \\mathbb{N*} \\newline f: \\mathbb{N*} \\rightarrow \\mathbb{N*} \\newline f(x) = \\begin{cases} n \u0026 x = 1 \\newline f(x - 1) + xm \u0026 x \u003e 1 \\end{cases} $$\nwhere n is our base, m is our multiplier and x is the level.\nI then wrote this up in my TypeScript codebase:\nexport function calculateRequiredXp(settings: GuildSettings, level: number): number { const { requiredXpBase, requiredXpMultiplier } = settings; if (level === 1) { return requiredXpBase; } return calculateRequiredXp(settings, level - 1) + requiredXpMultiplier * level; } It quickly became apparent to me that this was not going to perform all that well. Calculating what level a user is looked like this:\nexport function calculateUserLevel(settings: GuildSettings, user: User): number { for (let level = 1; ; level++) { const requiredXp = calculateRequiredXp(settings, level); if (user.xp \u003c requiredXp) { return level - 1; } } } If they were level N, we would actually be computing the XP required for level 1 N times. This is obviously not ideal, and I decided to try and optimize it. I opted for memoization and ended up with this:\nconst requiredXpMemo = new Map\u003c`${number}-${number}-${number}`, number\u003e(); export function calculateRequiredXp(settings: GuildSettings, level: number): number { const { requiredXpBase, requiredXpMultiplier } = settings; const memoKey = `${requiredXpBase}-${requiredXpMultiplier}-${level}` as const; if (requiredXpMemo.has(memoKey)) { return requiredXpMemo.get(memoKey)!; } const result = calculateRequiredXp(settings, level - 1) + requiredXpMultiplier * level; requiredXpMemo.set(memoKey, result); return result; } Math comes to the rescue - maybe This was already a lot better in terms of speed, but we were going to store a lot of values in that map, and I was confident that there was more room for improvement. I went back to my original f function and wrote it as a series: $a_x = a_{(x - 1)} + (x - 1) * m$, where $a_1 = n$ and $x \u003e 1$.\nCalculating the first few terms of this series, we get:\n$$ a_1 = n \\newline a_2 = n + m \\newline a_3 = n + 3m \\newline a_4 = n + 6m \\newline a_5 = n + 10m $$\nAt this point, my brain flashed me back throughout this fall when I did recurring series in math class. Unfortunately, other than a few specific cases, class had only really taught us how to “guess” a closed-form formula, and prove it using mathematical induction. Looking back, I’m a bit disappointed in myself for not trying that out more, but I digress.\nI noticed that in my series, only the coefficient of the m term was changing, and only depending on x. As such, I now knew that I could isolate the logic for calculating the coefficient of the m term into its own function, and only that would need to be recursive. Since that function would not rely on the values of n and m, the memoization was going to be a lot more powerful. I ended up with this:\nconst multiplifierCoefficientMemo = new Map\u003cnumber, number\u003e(); function calculateMultiplifierCoefficient(level: number): number { if (multiplifierCoefficientMemo.has(level)) { return multiplifierCoefficientMemo.get(level)!; } if (level === 1) { return 0; } const result = calculateMultiplifierCoefficient(level - 1) + level; multiplifierCoefficientMemo.set(level, result); return result; } export function calculateRequiredXp(settings: GuildSettings, level: number): number { const { requiredXpBase, requiredXpMultiplier } = settings; if (level === 1) { return requiredXpBase; } return requiredXpBase + level * requiredXpMultiplier * calculateMultiplifierCoefficient(level); } OEIS to the rescue Across the 2 days I worked on this, I was chatting with some friends about it, and around this point one of them suggested that I should plug my series into oeis, which I didn’t even know existed.\nSo, looking at our current calculateRequiredXp, we have:\n$$ n, m \\in \\mathbb{N*} \\newline f, g: \\mathbb{N*} \\rightarrow \\mathbb{N} \\newline g(x) = \\begin{cases} 0 \u0026 x = 1 \\newline g(x - 1) + x \u0026 x \u003e 1 \\end{cases} \\newline f(x) = n + x * m * g(x) $$\ng written out as a recurring series is $a_x = a_{(x - 1)} + x - 1$, where $a_1 = 0$ and $x \u003e 1$.\nOur first few terms are: 0, 1, 3, 6, 10, 15. I plugged this into oeis, and wouldn’t ya know it, this is the A000217 sequence, which does have a closed-form formula: $x * (2 * x - 1)$\nPlugging this back into our original function, we have:\n$$ n, m \\in \\mathbb{N*} \\newline f: \\mathbb{N*} \\rightarrow \\mathbb{N*} \\newline f(x) = n + x * m * (2 * x - 1) $$\nand in TypeScript land:\nexport function calculateRequiredXp(settings: GuildSettings, level: number): number { const { requiredXpBase, requiredXpMultiplier } = settings; return requiredXpBase + level * requiredXpMultiplier * (2 * level - 1); } Conclusion Even though I couldn’t figure out the closed-form formula myself, I’m still pretty happy about my thought process throughout this seemingly simple task. I’m particularly entusiasthic about the fact that I was able to use my math knowledge to solve a real-world problem, and I’m looking forward to using it even more in the future.\nIt’s also particularly gratifying to see that my code is a lot more efficient now.\n","wordCount":"1200","inLanguage":"en","datePublished":"2023-02-06T19:28:24+02:00","dateModified":"2023-02-06T19:28:24+02:00","author":{"@type":"Person","name":"didinele"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://didinele.me/blog/math-journey/"},"publisher":{"@type":"Organization","name":"DD's blog","logo":{"@type":"ImageObject","url":"https://didinele.me/favicon.ico"}}}</script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css integrity=sha384-vKruj+a13U8yHIkAyGgK1J3ArTLzrFGBbBc0tDp4ad/EyewESeXE/Iv67Aj8gKZ0 crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js integrity=sha384-PwRUT/YqbnEjkZO0zZxNqcxACrXe+j766U2amXcgMg5457rve2Y7I6ZJSm2A0mS4 crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous onload=renderMathInElement(document.body)></script>
<script>document.addEventListener("DOMContentLoaded",()=>{renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://didinele.me accesskey=h title="DD's blog (Alt + H)">DD's blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://didinele.me/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://didinele.me/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://didinele.me>Home</a>&nbsp;»&nbsp;<a href=https://didinele.me/blog/>Blogs</a></div><h1 class=post-title>A journey through code optimization (and highschool math)</h1><div class=post-meta><span title='2023-02-06 19:28:24 +0200 +0200'>February 6, 2023</span>&nbsp;·&nbsp;6 min&nbsp;·&nbsp;didinele&nbsp;|&nbsp;<a href=https://github.com/didinele/didinele.me/tree/main/content/blog/math-journey/index.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><ul><li><a href=#introduction aria-label=Introduction>Introduction</a></li></ul><li><a href=#optimization-problems aria-label="Optimization problems">Optimization problems</a></li><li><a href=#math-comes-to-the-rescue---maybe aria-label="Math comes to the rescue - maybe">Math comes to the rescue - maybe</a></li><li><a href=#oeis-to-the-rescue aria-label="OEIS to the rescue">OEIS to the rescue</a></li><li><a href=#conclusion aria-label=Conclusion>Conclusion</a></li></ul></div></details></div><div class=post-content><h2 id=introduction>Introduction<a hidden class=anchor aria-hidden=true href=#introduction>#</a></h2><p>At the time of writing this, I&rsquo;m a highschool student. With the way our school system is laid out, I end up doing
<em>a lot</em> of math - more so than computer science - and lately I&rsquo;ve been very passionate about it.</p><p>Anyways, our story begins on the 5th of February, 2023. I was working on a Discord bot for <a href=https://github.com/ChatSift>ChatSift</a>, responsible for
some sort of leveling system - users would gain XP for sending messages, and crossing certain thresholds would cause you
to level up. As I was working out my database schema, I landed on this:</p><pre tabindex=0><code class=language-prisma data-lang=prisma>model User {
  userId  String
  guildId String
  xp      Int    @default(0)

  @@id([userId, guildId])
}
</code></pre><p>and thought to myself, &ldquo;hmm, I could potentially get away with not storing the current level, and just calculate it on
the fly.&rdquo;</p><p>The main reason I even thought of this was because the formula to determine the XP required for a given level is
$base + (level - 1) * multiplier$. For example, if the base was <code>100</code>, and the multiplier was <code>50</code>, then the XP required
for level 1 would be <code>100</code>, and the XP required for level 2 would be <code>150</code>, and so on. This is a very simple formula, and
it would be trivial to track if the user had enough XP to level up, and if so, increment their level and subtract the XP
on the fly, but I thought it would be a headache to have to recompute the level for <em>every</em> user in the whole community if
an admin decided to change the <code>base</code> or the <code>multiplier</code>.</p><h1 id=optimization-problems>Optimization problems<a hidden class=anchor aria-hidden=true href=#optimization-problems>#</a></h1><p>As such, I opted to not store the level, and instead just store the <em>total</em> XP the user has <em>ever</em> accumulated, and
compute the level on the fly as-needed. At this point, I realized that calculating how much XP is needed for say, level 3,
is the sum of the XP required for levels 1, 2, and the usual $base + (level - 1) * multiplier$.</p><p>I then decided to represent this mathematically before implementing it, and I ended up with this:</p><p>$$
n, m \in \mathbb{N*} \newline
f: \mathbb{N*} \rightarrow \mathbb{N*} \newline
f(x) = \begin{cases}
n & x = 1 \newline
f(x - 1) + xm & x > 1
\end{cases}
$$</p><p>where <code>n</code> is our base, <code>m</code> is our multiplier and <code>x</code> is the level.</p><p>I then wrote this up in my TypeScript codebase:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>calculateRequiredXp</span><span class=p>(</span><span class=nx>settings</span>: <span class=kt>GuildSettings</span><span class=p>,</span> <span class=nx>level</span>: <span class=kt>number</span><span class=p>)</span><span class=o>:</span> <span class=kt>number</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=p>{</span> <span class=nx>requiredXpBase</span><span class=p>,</span> <span class=nx>requiredXpMultiplier</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>settings</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>level</span> <span class=o>===</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>requiredXpBase</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>calculateRequiredXp</span><span class=p>(</span><span class=nx>settings</span><span class=p>,</span> <span class=nx>level</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span> <span class=o>+</span> <span class=nx>requiredXpMultiplier</span> <span class=o>*</span> <span class=nx>level</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>It quickly became apparent to me that this was not going to perform all that well. Calculating what level a user is
looked like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>calculateUserLevel</span><span class=p>(</span><span class=nx>settings</span>: <span class=kt>GuildSettings</span><span class=p>,</span> <span class=nx>user</span>: <span class=kt>User</span><span class=p>)</span><span class=o>:</span> <span class=kt>number</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>level</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=p>;</span> <span class=nx>level</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=kr>const</span> <span class=nx>requiredXp</span> <span class=o>=</span> <span class=nx>calculateRequiredXp</span><span class=p>(</span><span class=nx>settings</span><span class=p>,</span> <span class=nx>level</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=nx>user</span><span class=p>.</span><span class=nx>xp</span> <span class=o>&lt;</span> <span class=nx>requiredXp</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>level</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>If they were level <code>N</code>, we would actually be computing the XP required for level 1 <code>N</code> times. This is obviously not
ideal, and I decided to try and optimize it. I opted for memoization and ended up with this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>const</span> <span class=nx>requiredXpMemo</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Map</span><span class=o>&lt;</span><span class=sb>`</span><span class=si>${</span><span class=kt>number</span><span class=si>}</span><span class=sb>-</span><span class=si>${</span><span class=kt>number</span><span class=si>}</span><span class=sb>-</span><span class=si>${</span><span class=kt>number</span><span class=si>}</span><span class=sb>`</span><span class=p>,</span> <span class=kt>number</span><span class=o>&gt;</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>calculateRequiredXp</span><span class=p>(</span><span class=nx>settings</span>: <span class=kt>GuildSettings</span><span class=p>,</span> <span class=nx>level</span>: <span class=kt>number</span><span class=p>)</span><span class=o>:</span> <span class=kt>number</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=p>{</span> <span class=nx>requiredXpBase</span><span class=p>,</span> <span class=nx>requiredXpMultiplier</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>settings</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>memoKey</span> <span class=o>=</span> <span class=sb>`</span><span class=si>${</span><span class=nx>requiredXpBase</span><span class=si>}</span><span class=sb>-</span><span class=si>${</span><span class=nx>requiredXpMultiplier</span><span class=si>}</span><span class=sb>-</span><span class=si>${</span><span class=nx>level</span><span class=si>}</span><span class=sb>`</span> <span class=kr>as</span> <span class=kr>const</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>requiredXpMemo</span><span class=p>.</span><span class=nx>has</span><span class=p>(</span><span class=nx>memoKey</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>requiredXpMemo</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=nx>memoKey</span><span class=p>)</span><span class=o>!</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>result</span> <span class=o>=</span> <span class=nx>calculateRequiredXp</span><span class=p>(</span><span class=nx>settings</span><span class=p>,</span> <span class=nx>level</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span> <span class=o>+</span> <span class=nx>requiredXpMultiplier</span> <span class=o>*</span> <span class=nx>level</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>requiredXpMemo</span><span class=p>.</span><span class=kr>set</span><span class=p>(</span><span class=nx>memoKey</span><span class=p>,</span> <span class=nx>result</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h1 id=math-comes-to-the-rescue---maybe>Math comes to the rescue - maybe<a hidden class=anchor aria-hidden=true href=#math-comes-to-the-rescue---maybe>#</a></h1><p>This was already a lot better in terms of speed, but we were going to store a lot of values in that map, and I was
confident that there was more room for improvement. I went back to my original <code>f</code> function and wrote it as a series:
$a_x = a_{(x - 1)} + (x - 1) * m$, where $a_1 = n$ and $x > 1$.</p><p>Calculating the first few terms of this series, we get:</p><p>$$
a_1 = n \newline
a_2 = n + m \newline
a_3 = n + 3m \newline
a_4 = n + 6m \newline
a_5 = n + 10m
$$</p><p>At this point, my brain flashed me back throughout this fall when I did recurring series in math class. Unfortunately,
other than a few specific cases, class had only really taught us how to &ldquo;guess&rdquo; a closed-form formula, and prove it
using mathematical induction. Looking back, I&rsquo;m a bit disappointed in myself for not trying that out more, but I digress.</p><p>I noticed that in my series, only the coefficient of the <code>m</code> term was changing, and only depending on <code>x</code>. As such,
I now knew that I could isolate the logic for calculating the coefficient of the <code>m</code> term into its own function,
and only that would need to be recursive. Since that function would not rely on the values of <code>n</code> and <code>m</code>, the
memoization was going to be a lot more powerful. I ended up with this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>const</span> <span class=nx>multiplifierCoefficientMemo</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Map</span><span class=p>&lt;</span><span class=nt>number</span><span class=err>,</span> <span class=na>number</span><span class=p>&gt;();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>calculateMultiplifierCoefficient</span><span class=p>(</span><span class=nx>level</span>: <span class=kt>number</span><span class=p>)</span><span class=o>:</span> <span class=kt>number</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>multiplifierCoefficientMemo</span><span class=p>.</span><span class=nx>has</span><span class=p>(</span><span class=nx>level</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>multiplifierCoefficientMemo</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=nx>level</span><span class=p>)</span><span class=o>!</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>level</span> <span class=o>===</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>result</span> <span class=o>=</span> <span class=nx>calculateMultiplifierCoefficient</span><span class=p>(</span><span class=nx>level</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span> <span class=o>+</span> <span class=nx>level</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>multiplifierCoefficientMemo</span><span class=p>.</span><span class=kr>set</span><span class=p>(</span><span class=nx>level</span><span class=p>,</span> <span class=nx>result</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>calculateRequiredXp</span><span class=p>(</span><span class=nx>settings</span>: <span class=kt>GuildSettings</span><span class=p>,</span> <span class=nx>level</span>: <span class=kt>number</span><span class=p>)</span><span class=o>:</span> <span class=kt>number</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=p>{</span> <span class=nx>requiredXpBase</span><span class=p>,</span> <span class=nx>requiredXpMultiplier</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>settings</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>level</span> <span class=o>===</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>requiredXpBase</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>requiredXpBase</span> <span class=o>+</span> <span class=nx>level</span> <span class=o>*</span> <span class=nx>requiredXpMultiplier</span> <span class=o>*</span> <span class=nx>calculateMultiplifierCoefficient</span><span class=p>(</span><span class=nx>level</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h1 id=oeis-to-the-rescue>OEIS to the rescue<a hidden class=anchor aria-hidden=true href=#oeis-to-the-rescue>#</a></h1><p>Across the 2 days I worked on this, I was chatting with some friends about it, and around this point one of them
suggested that I should plug my series into <a href=https://oeis.org/>oeis</a>, which I didn&rsquo;t even know existed.</p><p>So, looking at our current <code>calculateRequiredXp</code>, we have:</p><p>$$
n, m \in \mathbb{N*} \newline
f, g: \mathbb{N*} \rightarrow \mathbb{N} \newline
g(x) = \begin{cases}
0 & x = 1 \newline
g(x - 1) + x & x > 1
\end{cases} \newline
f(x) = n + x * m * g(x)
$$</p><p><code>g</code> written out as a recurring series is $a_x = a_{(x - 1)} + x - 1$, where $a_1 = 0$ and $x > 1$.</p><p>Our first few terms are: <code>0, 1, 3, 6, 10, 15</code>. I plugged this into <a href=https://oeis.org/>oeis</a>, and wouldn&rsquo;t ya know it,
this is the <a href=https://oeis.org/A000217>A000217 sequence</a>, which <strong>does</strong> have a closed-form formula: $x * (2 * x - 1)$</p><p>Plugging this back into our original function, we have:</p><p>$$
n, m \in \mathbb{N*} \newline
f: \mathbb{N*} \rightarrow \mathbb{N*} \newline
f(x) = n + x * m * (2 * x - 1)
$$</p><p>and in TypeScript land:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>calculateRequiredXp</span><span class=p>(</span><span class=nx>settings</span>: <span class=kt>GuildSettings</span><span class=p>,</span> <span class=nx>level</span>: <span class=kt>number</span><span class=p>)</span><span class=o>:</span> <span class=kt>number</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kr>const</span> <span class=p>{</span> <span class=nx>requiredXpBase</span><span class=p>,</span> <span class=nx>requiredXpMultiplier</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>settings</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>requiredXpBase</span> <span class=o>+</span> <span class=nx>level</span> <span class=o>*</span> <span class=nx>requiredXpMultiplier</span> <span class=o>*</span> <span class=p>(</span><span class=mi>2</span> <span class=o>*</span> <span class=nx>level</span> <span class=o>-</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h1 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h1><p>Even though I couldn&rsquo;t figure out the closed-form formula myself, I&rsquo;m still pretty happy about my thought process
throughout this seemingly simple task. I&rsquo;m particularly entusiasthic about the fact that I was able to use my math
knowledge to solve a real-world problem, and I&rsquo;m looking forward to using it even more in the future.</p><p>It&rsquo;s also particularly gratifying to see that my code is a lot more efficient now.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://didinele.me/tags/math/>math</a></li><li><a href=https://didinele.me/tags/algorithms/>algorithms</a></li><li><a href=https://didinele.me/tags/programming/>programming</a></li><li><a href=https://didinele.me/tags/optimization/>optimization</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://didinele.me>DD's blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>